<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/css/chat.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons+Round">
    <link
      rel="shortcut icon"
      type="image/ico"
      href="/static/images/favicon.ico"
    />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
      />

    <title>ChatRoom</title>
   
  </head>
  <body>
    <div class="container">
      <div class="smaller-container">
        <div class="chatbox">
          
          <div class="dropdown" name="room">
         
            <button
              class="btn btn-secondary dropdown-toggle roomname"
              type="button"
              id="dropdownMenuButton"
              data-toggle="dropdown"
              aria-haspopup="true"
              aria-expanded="false"
              name="room"
            >
          {{room.name}}
            </button>
            <div
              class="dropdown-menu"
              aria-labelledby="dropdownMenuButton"
              id="ddm"
            >
        
      
      
          <ul style=" color:black ;list-style-type:none; " > 
            <a style="color:black;text-decoration: none;" id="edit-button" href="/rooms/{{room_id}}/edit" class="material-icons">settings<em> Edit Room</em></a>
            <br>
            <span type="button" id="btn" class="material-icons-round" title="Leave Room">
              close<em>Leave Room</em>
              </span>

          </ul>
          
            </div>
            </div>
         
                 
         
            <form id="chatform">
              <input
                type="text"
                id="msg"
                placeholder="Type your text here"
                autocomplete="off"
              />
              
              <button class="material-icons-round" type="submit" id="send-message">send</button>
            </form>
            
        <!--ginger template-->
        <div class="message-container" id="messages">
         <div id="all-messages"> 
           <p id="start">&lt; messages start here &gt;</p>
          {% for message in messages %}
          {% if message.sender == current_user.username %}
          <div  class="sent-messages">
            <p id="sent-messages"> <b>{{message.sender}}&#160;</b><em>{{message.created_at}}&#160;</em><br>
            {{message.text}}<br></p>
          </div>
          {% else %}
          <div class="recieved-messages">
            <p id="recieved-messages"> <b>{{message.sender}}&#160;</b><em>{{message.created_at}}&#160;</em><br>
            {{message.text}}<br></p>
          </div>
          {%endif%}
          {% endfor %}
          <p id="gopal"></p>
          </div>
        </div>
      </div>
        <div class="menu">
          
          
            <br>
          <span onclick="logout()" title="logout" id=logout class="material-icons-round">
            logout
            </span>
        
        <div class="members-div">
          <span id="group-icon" class="material-icons-round" title="Show Members" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasWithBackdrop" aria-controls="offcanvasWithBackdrop">groups </span>
        </div>
          <div class="offcanvas offcanvas-start" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="offcanvasScrolling" aria-labelledby="offcanvasScrollingLabel">
            <div class="offcanvas-header">
              <h3 class="offcanvas-title" id="offcanvasScrollingLabel">Colored with scrolling</h3>
              <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            
          </div>
          <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasWithBackdrop" aria-labelledby="offcanvasWithBackdropLabel">
            <div class="offcanvas-header">
              <h3 class="offcanvas-title" id="offcanvasWithBackdropLabel">Members</h3>
              <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
              <p>
              <h5>Admin</h5>
              <ul> 
                {% for member in room_members %}
           
              <li>{{ member._id.username}}</li>
                {% endfor %}
              </ul></p>
              <ul>
                {% for admin in admins %}
                <li>{{admin}}</li>
                {% endfor %}
              </ul>
            </div>
          </div>
          
          </div>
        
     
      <div class="rooms-div">
        <h3> Your Rooms</h3><br>
        <ul>
          {% for room in rooms %}
            <li><a style="text-decoration:none;color:rgba(90, 194, 138, 1);" id="room-li" onclick="selectRoom()" href="/rooms/{{room._id.room_id}}/"> {{ room.room_name }}</a></li><br>
          {% endfor %}
        </ul>
      </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"
      integrity="sha512-q/dWJ3kcmjBLU4Qc47E4A9kTB4m3wuTY7vkFJDTZKjTs8jhyGQnaUrxa0Ytd0ssMZhbNua9hE+E7Qv1j+DyZwA=="
      crossorigin="anonymous"
    ></script>
    <script>
      selectRoom = () => {
  let room = document.getElementById("room-li").innerHTML;
  console.log(room);
 
  
};
      const socket = io.connect("http://127.0.0.1:5000/");

      socket.on("connect", function () {
        socket.emit("join_room", {
          username: "{{username}}",

          room: "{{room._id}}",
        });
        
        let msg_input = document.getElementById("msg");

        document.getElementById("chatform").onsubmit = function (e) {
          e.preventDefault();
          let message = msg_input.value.trim();
          if (message.length) {
            socket.emit("send_msg", {
              username: "{{username}}",
              room: "{{room._id}}",
              message: message,
            });
          }
        
          msg_input.value = "";
          msg_input.focus();
        };

        const leave = document.getElementById("btn");
        leave.onclick = function (e) {
          socket.emit("leave_room", {
            username: "{{username}}",
            room: "{{room._id}}",
          });
          socket.disconnect();
          window.location.href = "{{url_for('home')}}";
        };
      });

      socket.on("receive_msg", function (data) {
        console.log(data);
        const newNode = document.createElement("span");
        
        newNode.innerHTML = `<p id="sent-messages"><b>${data.username}&nbsp;</b> <em>${data.created_at}&nbsp;</em><br>${data.message}<br></p>`;
        document.getElementById("all-messages").appendChild(newNode);
        let chatMessage = document.getElementById('all-messages');
        chatMessage.scrollTop = chatMessage.scrollHeight

      });

      socket.on("join_room_announcement", function (data, messages) {
        console.log(data);
        const newNode = document.getElementById("gopal");
        newNode.innerHTML = `<b>${data.username}</b> has joined the room `;
        //document.getElementById("messages").appendChild(newNode);
        let chatMessage = document.getElementById('all-messages');
        chatMessage.scrollTop = chatMessage.scrollHeight

      });
      socket.on("leave_room_announcement", function (data) {
        console.log(data);
        const newNode = document.getElementById("gopal");
        newNode.innerHTML = `<b >${data.username}</b> has left the room`;
        let chatMessage = document.getElementById('all-messages');
        chatMessage.scrollTop = chatMessage.scrollHeight
        //document.getElementById("room-announcement").appendChild(newNode);
      });

      logout = () => {
        window.location.href = "{{url_for('logout')}}";
      };
    </script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns" crossorigin="anonymous"></script>
  
  </body>
</html>
